<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè¦‹ç©æ›¸ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #eee;
            margin-bottom: 30px;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .tab:hover {
            background: #f5f5f5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .estimate-items {
            margin-top: 20px;
        }

        .item-row {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1.5fr 1.5fr 60px;
            gap: 10px;
            margin-bottom: 15px;
            align-items: end;
        }

        .price-info {
            grid-column: 4 / 6;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 8px;
            margin-top: 5px;
            font-size: 12px;
            display: none;
        }

        .price-info.active {
            display: block;
        }

        .price-info .base-price {
            color: #6c757d;
        }

        .price-info .adjusted-price {
            color: #667eea;
            font-weight: bold;
        }

        .price-info .price-difference {
            color: #dc3545;
            font-weight: bold;
        }

        .price-info .price-difference.positive {
            color: #dc3545;
        }

        .price-info .price-difference.negative {
            color: #28a745;
        }

        .remove-btn {
            background: #e74c3c;
            padding: 12px;
            font-size: 14px;
        }

        .add-item-btn {
            background: #27ae60;
            margin-top: 10px;
        }

        .total-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
            text-align: right;
        }

        .total-amount {
            font-size: 2em;
            color: #667eea;
            font-weight: bold;
        }

        .message {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            display: none;
            white-space: pre-line;
            font-size: 14px;
            line-height: 1.6;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-left: 4px solid #28a745;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-left: 4px solid #dc3545;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #667eea;
            color: white;
        }

        tr:hover {
            background: #f5f5f5;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AIè¦‹ç©æ›¸ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ </h1>
            <p class="subtitle">åŠ¹ç‡çš„ãªè¦‹ç©æ›¸ä½œæˆã‚’ã‚µãƒãƒ¼ãƒˆ</p>
        </header>

        <div class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('estimate')">è¦‹ç©ä½œæˆ</button>
                <button class="tab" onclick="switchTab('customer')">é¡§å®¢ç™»éŒ²</button>
                <button class="tab" onclick="switchTab('history')">è¦‹ç©å±¥æ­´</button>
            </div>

            <div id="message" class="message"></div>

            <!-- è¦‹ç©ä½œæˆã‚¿ãƒ– -->
            <div id="estimate-tab" class="tab-content active">
                <h2>è¦‹ç©æ›¸ä½œæˆ</h2>

                <div class="form-group">
                    <label>é¡§å®¢é¸æŠ <span style="color: red;">*</span></label>
                    <select id="customer-select" style="font-size: 16px; padding: 15px;">
                        <option value="">â–¼ é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„...</option>
                    </select>
                </div>

                <div id="customer-info" style="display: none; background: #f0f8ff; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">é¸æŠä¸­ã®é¡§å®¢æƒ…å ±</h4>
                    <p id="customer-details"></p>
                </div>

                <h3>è¦‹ç©é …ç›®</h3>
                <div class="estimate-items" id="estimate-items">
                    <div class="item-row">
                        <div>
                            <label>å•†å“å <span style="color: red;">*</span></label>
                            <select class="product-select" style="font-size: 14px;">
                                <option value="">â–¼ å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„...</option>
                            </select>
                        </div>
                        <div>
                            <label>æ•°é‡</label>
                            <input type="number" class="quantity" value="1" min="1">
                        </div>
                        <div>
                            <label>å˜ä½</label>
                            <input type="text" class="unit" value="å€‹" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label>å˜ä¾¡ï¼ˆå††ï¼‰</label>
                            <input type="number" class="unit-price" value="0">
                        </div>
                        <div>
                            <label>é‡‘é¡ï¼ˆå††ï¼‰</label>
                            <input type="number" class="amount" value="0" readonly style="background: #f5f5f5; font-weight: bold;">
                        </div>
                        <div>
                            <label>&nbsp;</label>
                            <button class="remove-btn" onclick="removeItem(this)">å‰Šé™¤</button>
                        </div>
                        <div class="price-info">
                            <div class="base-price">åŸºæœ¬ä¾¡æ ¼: Â¥<span class="base-price-value">0</span></div>
                            <div class="adjusted-price">èª¿æ•´å¾Œ: Â¥<span class="adjusted-price-value">0</span></div>
                            <div class="price-difference">å·®é¡: <span class="diff-value">Â¥0</span> (<span class="diff-percent">0%</span>)</div>
                        </div>
                    </div>
                </div>

                <button class="add-item-btn" onclick="addItem()">+ é …ç›®ã‚’è¿½åŠ </button>

                <div class="total-section">
                    <p>åˆè¨ˆé‡‘é¡</p>
                    <div class="total-amount" id="total-amount">Â¥0</div>
                </div>

                <div class="form-group">
                    <label>å‚™è€ƒ</label>
                    <textarea id="notes" rows="3" placeholder="ä¾‹: é…é€è²»è¾¼ã¿ã®ä¾¡æ ¼ã§ã™ã€‚è¨­ç½®ä½œæ¥­ãŒå¿…è¦ãªå ´åˆã¯åˆ¥é€”ãŠè¦‹ç©ã‚Šã„ãŸã—ã¾ã™ã€‚"></textarea>
                </div>

                <button onclick="generateEstimate()" style="font-size: 18px; padding: 15px 40px;">ğŸ“„ è¦‹ç©æ›¸ã‚’ç”Ÿæˆ</button>
            </div>

            <!-- é¡§å®¢ç™»éŒ²ã‚¿ãƒ– -->
            <div id="customer-tab" class="tab-content">
                <h2>æ–°è¦é¡§å®¢ç™»éŒ²</h2>

                <!-- PDFã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 30px; border: 2px dashed #667eea;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">ğŸ“„ è¦‹ç©æ›¸PDFã‹ã‚‰è‡ªå‹•ç™»éŒ²</h3>
                    <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                        è¦‹ç©æ›¸PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€é¡§å®¢æƒ…å ±ã¨å•†å“æƒ…å ±ã‚’è‡ªå‹•çš„ã«æŠ½å‡ºã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚
                    </p>
                    <div class="form-group">
                        <input type="file" id="pdf-file" accept=".pdf" style="padding: 10px; border: 2px solid #ddd;">
                    </div>
                    <button onclick="uploadPDF()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        ğŸ“¤ PDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </button>
                </div>

                <hr style="margin: 30px 0; border: 1px solid #eee;">

                <h3 style="margin-bottom: 20px;">ã¾ãŸã¯æ‰‹å‹•ã§ç™»éŒ²</h3>

                <div class="form-group">
                    <label>ä¼šç¤¾å <span style="color: red;">*</span></label>
                    <input type="text" id="company-name" placeholder="ä¾‹: æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«å•†äº‹" required>
                </div>

                <div class="form-group">
                    <label>ä½æ‰€ <span style="color: red;">*</span></label>
                    <input type="text" id="address" placeholder="ä¾‹: æ±äº¬éƒ½åƒä»£ç”°åŒºåƒä»£ç”°1-1-1" required>
                    <small style="color: #666; font-size: 12px;">â€» ä½æ‰€ã‹ã‚‰è‡ªå‹•çš„ã«åº§æ¨™ã‚’å–å¾—ã—ã€æ‹ ç‚¹ã‹ã‚‰ã®è·é›¢ã‚’è¨ˆç®—ã—ã¾ã™</small>
                </div>

                <div class="form-group">
                    <label>é›»è©±ç•ªå·</label>
                    <input type="tel" id="phone" placeholder="ä¾‹: 03-1234-5678">
                </div>

                <div class="form-group">
                    <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="email" placeholder="ä¾‹: contact@example.com">
                </div>

                <button onclick="registerCustomer()">é¡§å®¢ã‚’ç™»éŒ²</button>
            </div>

            <!-- è¦‹ç©å±¥æ­´ã‚¿ãƒ– -->
            <div id="history-tab" class="tab-content">
                <h2>è¦‹ç©å±¥æ­´</h2>
                <table id="estimate-history">
                    <thead>
                        <tr>
                            <th>è¦‹ç©ç•ªå·</th>
                            <th>é¡§å®¢å</th>
                            <th>é‡‘é¡</th>
                            <th>ä½œæˆæ—¥</th>
                            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let customers = [];
        let products = [];
        let selectedCustomerDistance = 0; // é¸æŠã•ã‚ŒãŸé¡§å®¢ã®è·é›¢

        // åˆæœŸåŒ–
        async function init() {
            console.log('ğŸš€ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹...');
            try {
                await loadCustomers();
                await loadProducts();
                await loadEstimateHistory();
                console.log('âœ… ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('âŒ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
            }
        }

        // é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadCustomers() {
            console.log('ğŸ“¥ é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
            try {
                const response = await fetch('/api/customers');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                customers = await response.json();
                console.log(`âœ… é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ${customers.length}ä»¶`);

                const select = document.getElementById('customer-select');
                select.innerHTML = '<option value="">â–¼ é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„...</option>';

                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.customer_id;
                    const distance = customer.distance_km ? ` [æ‹ ç‚¹ã‹ã‚‰ ${customer.distance_km.toFixed(1)}km]` : '';
                    option.textContent = `${customer.company_name}${distance} - ${customer.address}`;
                    option.dataset.companyName = customer.company_name;
                    option.dataset.address = customer.address;
                    option.dataset.phone = customer.phone || '';
                    option.dataset.distance = customer.distance_km || '';
                    select.appendChild(option);
                });

                // é¡§å®¢é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                select.addEventListener('change', async function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const customerInfo = document.getElementById('customer-info');
                    const customerDetails = document.getElementById('customer-details');

                    if (this.value) {
                        // é¸æŠã•ã‚ŒãŸé¡§å®¢ã®è·é›¢ã‚’ä¿å­˜
                        selectedCustomerDistance = parseFloat(selectedOption.dataset.distance) || 0;

                        const distance = selectedOption.dataset.distance ?
                            `<br>ğŸ“ æ‹ ç‚¹ã‹ã‚‰ã®è·é›¢: ${parseFloat(selectedOption.dataset.distance).toFixed(1)} km` : '';
                        const phone = selectedOption.dataset.phone ?
                            `<br>ğŸ“ é›»è©±: ${selectedOption.dataset.phone}` : '';

                        customerDetails.innerHTML = `
                            <strong>ğŸ¢ ${selectedOption.dataset.companyName}</strong>
                            <br>ğŸ“® ä½æ‰€: ${selectedOption.dataset.address}${phone}${distance}
                        `;
                        customerInfo.style.display = 'block';

                        // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹å•†å“ã®ä¾¡æ ¼ã‚’å†è¨ˆç®—
                        await recalculateAllPrices();
                    } else {
                        selectedCustomerDistance = 0;
                        customerInfo.style.display = 'none';

                        // ä¾¡æ ¼æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ
                        await recalculateAllPrices();
                    }
                });
            } catch (error) {
                console.error('âŒ é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }

        // å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadProducts() {
            console.log('ğŸ“¥ å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
            try {
                const response = await fetch('/api/products');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                products = await response.json();
                console.log(`âœ… å•†å“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ${products.length}ä»¶`);

                await updateProductSelects();
            } catch (error) {
                console.error('âŒ å•†å“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }

        // å•†å“é¸æŠè‚¢ã‚’æ›´æ–°ï¼ˆè·é›¢èª¿æ•´ä¾¡æ ¼ã‚’åæ˜ ï¼‰
        async function updateProductSelects() {
            console.log('ğŸ“¦ å•†å“é¸æŠè‚¢ã‚’æ›´æ–°ä¸­... (selectedCustomerDistance:', selectedCustomerDistance, 'km)');
            const selects = document.querySelectorAll('.product-select');

            for (const select of selects) {
                // ç¾åœ¨ã®é¸æŠå€¤ã‚’ä¿å­˜
                const currentValue = select.value;

                select.innerHTML = '<option value="">â–¼ å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„...</option>';

                for (const product of products) {
                    const option = document.createElement('option');
                    option.value = product.product_id;
                    const category = product.product_category ? `[${product.product_category}] ` : '';

                    // åŸºæœ¬ä¾¡æ ¼ã‚’è¡¨ç¤ºï¼ˆåˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã¯è·é›¢èª¿æ•´ä¾¡æ ¼ã‚’è¨ˆç®—ã—ãªã„ï¼‰
                    let priceDisplay = `Â¥${product.base_price.toLocaleString()}`;

                    // è·é›¢èª¿æ•´ä¾¡æ ¼ã®è¨ˆç®—ã¯å•†å“é¸æŠæ™‚ã®ã¿è¡Œã†ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ï¼‰
                    // updateProductSelects()ã§ã¯åŸºæœ¬ä¾¡æ ¼ã®ã¿è¡¨ç¤º

                    option.textContent = `${category}${product.product_name} - ${priceDisplay} / ${product.unit}`;
                    option.dataset.basePrice = product.base_price;
                    option.dataset.unit = product.unit;
                    option.dataset.name = product.product_name;
                    option.dataset.category = product.product_category || '';
                    option.dataset.productId = product.product_id;
                    select.appendChild(option);
                }

                // ä¿å­˜ã—ãŸé¸æŠå€¤ã‚’å¾©å…ƒ
                if (currentValue) {
                    select.value = currentValue;
                }

                // å•†å“é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆé‡è¤‡ç™»éŒ²ã‚’é˜²ããŸã‚ã€æ—¢ã«ã‚¤ãƒ™ãƒ³ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
                if (!select.dataset.eventAttached) {
                    select.dataset.eventAttached = 'true';
                    select.addEventListener('change', async function() {
                        const row = this.closest('.item-row');
                        const selectedOption = this.options[this.selectedIndex];

                        if (selectedOption.value) {
                            row.querySelector('.unit').value = selectedOption.dataset.unit;

                            // è·é›¢èª¿æ•´ä¾¡æ ¼ã‚’è¨ˆç®—ã—ã¦ä¾¡æ ¼æƒ…å ±ã‚’è¡¨ç¤º
                            const productId = selectedOption.value;
                            const basePrice = parseInt(selectedOption.dataset.basePrice);
                            const quantity = parseInt(row.querySelector('.quantity').value) || 1;

                            const result = await calculateDistanceAdjustedPriceWithInfo(productId, basePrice, selectedCustomerDistance, quantity);

                            row.querySelector('.unit-price').value = result.adjusted_price;
                            calculateRowAmount(row);

                            // ä¾¡æ ¼æƒ…å ±ã‚’è¡¨ç¤º
                            displayPriceInfo(row, result);

                            // é¸æŠã•ã‚ŒãŸå•†å“ã‚’è¦–è¦šçš„ã«å¼·èª¿
                            this.style.borderColor = '#667eea';
                            this.style.borderWidth = '2px';
                        } else {
                            this.style.borderColor = '#ddd';
                            this.style.borderWidth = '2px';

                            // ä¾¡æ ¼æƒ…å ±ã‚’éè¡¨ç¤º
                            row.querySelector('.price-info').classList.remove('active');
                        }
                    });
                }
            }
        }

        // é …ç›®ã‚’è¿½åŠ 
        async function addItem() {
            const container = document.getElementById('estimate-items');
            const newRow = container.querySelector('.item-row').cloneNode(true);

            // å€¤ã‚’ãƒªã‚»ãƒƒãƒˆ
            newRow.querySelector('.product-select').value = '';
            newRow.querySelector('.quantity').value = 1;
            newRow.querySelector('.unit').value = 'å€‹';
            newRow.querySelector('.unit-price').value = 0;
            newRow.querySelector('.amount').value = 0;

            // ä¾¡æ ¼æƒ…å ±ã‚’éè¡¨ç¤º
            newRow.querySelector('.price-info').classList.remove('active');

            container.appendChild(newRow);
            await updateProductSelects();
            attachCalculationEvents(newRow);
        }

        // é …ç›®ã‚’å‰Šé™¤
        function removeItem(button) {
            const container = document.getElementById('estimate-items');
            if (container.querySelectorAll('.item-row').length > 1) {
                button.closest('.item-row').remove();
                calculateTotal();
            }
        }

        // è¡Œã®é‡‘é¡ã‚’è¨ˆç®—
        function calculateRowAmount(row) {
            const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
            const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
            const amount = quantity * unitPrice;

            row.querySelector('.amount').value = amount;
            calculateTotal();
        }

        // åˆè¨ˆã‚’è¨ˆç®—
        function calculateTotal() {
            const rows = document.querySelectorAll('.item-row');
            let total = 0;

            rows.forEach(row => {
                const amount = parseFloat(row.querySelector('.amount').value) || 0;
                total += amount;
            });

            document.getElementById('total-amount').textContent = `Â¥${total.toLocaleString()}`;
        }

        // è¨ˆç®—ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¢ã‚¿ãƒƒãƒ
        function attachCalculationEvents(row) {
            row.querySelector('.quantity').addEventListener('input', async () => {
                calculateRowAmount(row);

                // æ•°é‡å¤‰æ›´æ™‚ã«ä¾¡æ ¼æƒ…å ±ã‚’å†è¨ˆç®—
                const productSelect = row.querySelector('.product-select');
                const selectedOption = productSelect.options[productSelect.selectedIndex];

                if (selectedOption.value) {
                    const productId = selectedOption.value;
                    const basePrice = parseInt(selectedOption.dataset.basePrice);
                    const quantity = parseInt(row.querySelector('.quantity').value) || 1;

                    const result = await calculateDistanceAdjustedPriceWithInfo(productId, basePrice, selectedCustomerDistance, quantity);
                    row.querySelector('.unit-price').value = result.adjusted_price;
                    calculateRowAmount(row);
                    displayPriceInfo(row, result);
                }
            });

            row.querySelector('.unit-price').addEventListener('input', () => calculateRowAmount(row));
        }

        // åˆæœŸã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        document.querySelectorAll('.item-row').forEach(row => {
            attachCalculationEvents(row);
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');

            if (tabName === 'history') {
                loadEstimateHistory();
            }
        }

        // é¡§å®¢ã‚’ç™»éŒ²
        async function registerCustomer() {
            const data = {
                company_name: document.getElementById('company-name').value,
                address: document.getElementById('address').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value
            };

            if (!data.company_name || !data.address) {
                showMessage('ä¼šç¤¾åã¨ä½æ‰€ã¯å¿…é ˆã§ã™', 'error');
                return;
            }

            const response = await fetch('/api/customer', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                const distanceInfo = result.distance_km ?
                    `\nğŸ“ æ‹ ç‚¹ã‹ã‚‰ã®è·é›¢: ${result.distance_km.toFixed(1)} km` : '';
                showMessage(`âœ… é¡§å®¢ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼\nğŸ¢ ${data.company_name}${distanceInfo}`, 'success');
                await loadCustomers();

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('company-name').value = '';
                document.getElementById('address').value = '';
                document.getElementById('phone').value = '';
                document.getElementById('email').value = '';

                // è¦‹ç©ä½œæˆã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
                setTimeout(() => {
                    document.querySelector('.tab').click();
                }, 2000);
            } else {
                showMessage(`âŒ é¡§å®¢ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`, 'error');
            }
        }

        // è¦‹ç©æ›¸ã‚’ç”Ÿæˆ
        async function generateEstimate() {
            const customerId = document.getElementById('customer-select').value;

            if (!customerId) {
                showMessage('âŒ é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                document.getElementById('customer-select').focus();
                return;
            }

            const rows = document.querySelectorAll('.item-row');
            const items = [];
            let hasEmptyProduct = false;

            rows.forEach(row => {
                const productSelect = row.querySelector('.product-select');
                const selectedOption = productSelect.options[productSelect.selectedIndex];

                if (selectedOption.value) {
                    const quantity = parseFloat(row.querySelector('.quantity').value);
                    const unitPrice = parseFloat(row.querySelector('.unit-price').value);

                    if (quantity <= 0 || unitPrice < 0) {
                        hasEmptyProduct = true;
                        return;
                    }

                    items.push({
                        name: selectedOption.dataset.name,
                        quantity: quantity,
                        unit: row.querySelector('.unit').value,
                        unit_price: unitPrice,
                        amount: parseFloat(row.querySelector('.amount').value)
                    });
                }
            });

            if (hasEmptyProduct) {
                showMessage('âŒ æ•°é‡ã¨å˜ä¾¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (items.length === 0) {
                showMessage('âŒ è¦‹ç©é …ç›®ã‚’å°‘ãªãã¨ã‚‚1ã¤è¿½åŠ ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const data = {
                customer_id: customerId,
                items: items,
                notes: document.getElementById('notes').value
            };

            const response = await fetch('/api/generate_estimate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                const totalAmount = items.reduce((sum, item) => sum + item.amount, 0);
                showMessage(`âœ… è¦‹ç©æ›¸ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼\nè¦‹ç©ç•ªå·: ${result.estimate_number}\nåˆè¨ˆé‡‘é¡: Â¥${totalAmount.toLocaleString()}\nPDFãƒ•ã‚¡ã‚¤ãƒ«: ${result.pdf_path}`, 'success');
                await loadEstimateHistory();

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('customer-select').value = '';
                document.getElementById('customer-info').style.display = 'none';
                document.getElementById('notes').value = '';

                // è¦‹ç©é …ç›®ã‚’1ã¤ã ã‘ã«æˆ»ã™
                const container = document.getElementById('estimate-items');
                const rows = container.querySelectorAll('.item-row');
                rows.forEach((row, index) => {
                    if (index > 0) row.remove();
                });

                // æœ€åˆã®è¡Œã‚’ãƒªã‚»ãƒƒãƒˆ
                const firstRow = container.querySelector('.item-row');
                firstRow.querySelector('.product-select').value = '';
                firstRow.querySelector('.quantity').value = 1;
                firstRow.querySelector('.unit').value = 'å€‹';
                firstRow.querySelector('.unit-price').value = 0;
                firstRow.querySelector('.amount').value = 0;
                calculateTotal();
            } else {
                showMessage(`âŒ è¦‹ç©æ›¸ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`, 'error');
            }
        }

        // è¦‹ç©å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
        async function loadEstimateHistory() {
            console.log('ğŸ“¥ è¦‹ç©å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...');
            try {
                const response = await fetch('/api/estimates');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const estimates = await response.json();
                console.log(`âœ… è¦‹ç©å±¥æ­´èª­ã¿è¾¼ã¿å®Œäº†: ${estimates.length}ä»¶`);

                const tbody = document.querySelector('#estimate-history tbody');
                tbody.innerHTML = '';

                estimates.forEach(estimate => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>EST-${estimate.estimate_id}</td>
                        <td>${estimate.company_name}</td>
                        <td>Â¥${estimate.total_amount.toLocaleString()}</td>
                        <td>${new Date(estimate.created_at).toLocaleDateString('ja-JP')}</td>
                        <td>${estimate.status}</td>
                    `;
                });
            } catch (error) {
                console.error('âŒ è¦‹ç©å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                // è¦‹ç©å±¥æ­´ã¯ã‚¨ãƒ©ãƒ¼ã§ã‚‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ç¶šè¡Œ
            }
        }

        // è·é›¢èª¿æ•´ä¾¡æ ¼ã‚’è¨ˆç®—ï¼ˆè©³ç´°æƒ…å ±ä»˜ãï¼‰
        async function calculateDistanceAdjustedPriceWithInfo(productId, basePrice, distanceKm, quantity = 1) {
            try {
                const response = await fetch('/api/calculate_distance_price', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        product_id: productId,
                        base_price: basePrice,
                        distance_km: distanceKm,
                        quantity: quantity
                    })
                });

                const result = await response.json();

                if (result.success) {
                    return result.result;
                } else {
                    console.error('ä¾¡æ ¼èª¿æ•´ã‚¨ãƒ©ãƒ¼:', result.error);
                    return {
                        base_price: basePrice,
                        adjusted_price: basePrice,
                        adjustment_amount: 0,
                        adjustment_type: 'fixed'
                    };
                }
            } catch (error) {
                console.error('ä¾¡æ ¼è¨ˆç®—APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
                return {
                    base_price: basePrice,
                    adjusted_price: basePrice,
                    adjustment_amount: 0,
                    adjustment_type: 'fixed'
                };
            }
        }

        // ä¾¡æ ¼æƒ…å ±ã‚’è¡¨ç¤º
        function displayPriceInfo(row, result) {
            const priceInfo = row.querySelector('.price-info');
            const basePriceValue = priceInfo.querySelector('.base-price-value');
            const adjustedPriceValue = priceInfo.querySelector('.adjusted-price-value');
            const diffValue = priceInfo.querySelector('.diff-value');
            const diffPercent = priceInfo.querySelector('.diff-percent');
            const diffContainer = priceInfo.querySelector('.price-difference');

            basePriceValue.textContent = result.base_price.toLocaleString();
            adjustedPriceValue.textContent = result.adjusted_price.toLocaleString();

            const diff = result.adjustment_amount;
            const diffPercentValue = result.base_price > 0 ? (diff / result.base_price * 100).toFixed(1) : 0;

            if (diff > 0) {
                diffValue.textContent = `+Â¥${diff.toLocaleString()}`;
                diffPercent.textContent = `+${diffPercentValue}%`;
                diffContainer.className = 'price-difference positive';
            } else if (diff < 0) {
                diffValue.textContent = `-Â¥${Math.abs(diff).toLocaleString()}`;
                diffPercent.textContent = `${diffPercentValue}%`;
                diffContainer.className = 'price-difference negative';
            } else {
                diffValue.textContent = 'Â¥0';
                diffPercent.textContent = '0%';
                diffContainer.className = 'price-difference';
            }

            priceInfo.classList.add('active');
        }

        // ã™ã¹ã¦ã®å•†å“ã®ä¾¡æ ¼ã‚’å†è¨ˆç®—
        async function recalculateAllPrices() {
            const rows = document.querySelectorAll('.item-row');

            for (const row of rows) {
                const productSelect = row.querySelector('.product-select');
                const selectedOption = productSelect.options[productSelect.selectedIndex];

                if (selectedOption.value) {
                    const productId = selectedOption.value;
                    const basePrice = parseInt(selectedOption.dataset.basePrice);
                    const quantity = parseInt(row.querySelector('.quantity').value) || 1;

                    const result = await calculateDistanceAdjustedPriceWithInfo(productId, basePrice, selectedCustomerDistance, quantity);

                    row.querySelector('.unit-price').value = result.adjusted_price;
                    calculateRowAmount(row);
                    displayPriceInfo(row, result);
                }
            }
        }

        // PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadPDF() {
            const fileInput = document.getElementById('pdf-file');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('âŒ PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showMessage('âŒ PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            // FormDataã‚’ä½œæˆ
            const formData = new FormData();
            formData.append('file', file);

            try {
                showMessage('ğŸ“¤ PDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'success');

                const response = await fetch('/api/upload_pdf', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    const message = `âœ… PDFã‹ã‚‰æƒ…å ±ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼\n\n` +
                        `ğŸ‘¥ é¡§å®¢: ${result.customers_added}ä»¶è¿½åŠ \n` +
                        `ğŸ“¦ å•†å“: ${result.products_added}ä»¶è¿½åŠ \n\n` +
                        `é¡§å®¢å: ${result.customer_name || 'ä¸æ˜'}\n` +
                        `ç·å•†å“æ•°: ${result.total_products}ä»¶`;

                    showMessage(message, 'success');

                    // é¡§å®¢ã¨å•†å“ã®ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                    await loadCustomers();
                    await loadProducts();

                    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                    fileInput.value = '';

                    // 2ç§’å¾Œã«è¦‹ç©ä½œæˆã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
                    setTimeout(() => {
                        document.querySelector('.tab').click();
                    }, 2000);
                } else {
                    showMessage(`âŒ PDFã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ\n${result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`, 'error');
                }
            } catch (error) {
                showMessage(`âŒ PDFã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ\n${error.message}`, 'error');
                console.error('PDFã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = `message ${type}`;
            message.style.display = 'block';

            setTimeout(() => {
                message.style.display = 'none';
            }, 5000);
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        init();
    </script>
</body>
</html>
